<div class="reservation-page">
  <div class="header-section">
    <h2>Explore Venues</h2>
    <button mat-flat-button color="accent" (click)="toggleMap()" *ngIf="!showMap && searchResults.length > 0">
      <mat-icon>map</mat-icon> Map View
    </button>
  </div>

  <div class="search-bar" [formGroup]="reservationForm">

    <mat-form-field appearance="outline" class="no-bottom-padding" style="flex: 2;">
      <mat-icon matPrefix>search</mat-icon>
      <input matInput placeholder="Where to?" formControlName="locationQuery">
    </mat-form-field>

    <mat-form-field appearance="outline" class="no-bottom-padding" style="flex: 1; min-width: 140px;">
      <mat-label>Type</mat-label>
      <mat-select formControlName="locationType">
        <mat-option [value]="null">Any Type</mat-option>
        <mat-option *ngFor="let type of locationTypes" [value]="type">{{ type }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="no-bottom-padding" style="flex: 0 0 110px;">
      <mat-label>Capacity</mat-label>
      <input matInput type="number" formControlName="capacity" min="1">
      <span matSuffix style="font-size: 11px; color: #888;">ppl &nbsp;</span>
    </mat-form-field>

    <mat-form-field appearance="outline" class="no-bottom-padding" style="flex: 1.5;">
      <mat-date-range-input [formGroup]="reservationForm.get('dateRange')" [rangePicker]="picker">
        <input matStartDate placeholder="Check-in" formControlName="start">
        <input matEndDate placeholder="Check-out" formControlName="end">
      </mat-date-range-input>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker></mat-date-range-picker>
    </mat-form-field>

    <button mat-flat-button color="primary" class="search-btn" (click)="search()">Search</button>
  </div>

  <div *ngIf="searchResults.length && !showMap" class="results-container">
    <div class="booking-card" *ngFor="let loc of searchResults">
      <div class="card-image-wrapper">
        <div class="image-carousel" *ngIf="loc.imageUrls && loc.imageUrls.length > 0; else noImage">
          <img [src]="loc.imageUrls[loc.currentImageIndex!]" alt="Location">

          <button class="nav-btn prev" *ngIf="loc.imageUrls.length > 1" (click)="prevImage($event, loc)">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <button class="nav-btn next" *ngIf="loc.imageUrls.length > 1" (click)="nextImage($event, loc)">
            <mat-icon>chevron_right</mat-icon>
          </button>

          <div class="dots" *ngIf="loc.imageUrls.length > 1">
            <span *ngFor="let img of loc.imageUrls; let i = index" [class.active]="i === loc.currentImageIndex"></span>
          </div>
        </div>
        <ng-template #noImage>
          <div class="placeholder-image">
            <mat-icon>image_not_supported</mat-icon>
          </div>
        </ng-template>
      </div>

      <div class="card-details">
        <div class="header-row">
          <h3>{{ loc.name }}</h3>
          <span class="badge-type">{{ loc.location_type }}</span>
        </div>

        <div class="location-row">
          <mat-icon inline style="font-size:16px; margin-right:4px;">location_on</mat-icon>
          <span>{{ loc.address }}</span>
        </div>

        <div class="tags-row">
          <span class="tag">Up to {{ loc.capacity }} Guests</span>
        </div>

        <div class="description-preview">
          {{ loc.description || 'A beautiful venue perfect for your next event. Features modern amenities and great
          location.' }}
        </div>
      </div>

      <div class="card-pricing">
        <div class="price-box">
          <span class="price-label">Daily Rate</span>
          <span class="price-value">€ {{ loc.price }}</span>
        </div>
        <button mat-flat-button color="primary" [routerLink]="['/reservation', loc.arcgis_feature_id]">
          Reserve
        </button>
      </div>
    </div>
  </div>

  <div #mapViewNode id="mapViewNode" [class.fullscreen]="showMap" *ngIf="showMap" class="map-container">
    <button class="close-btn-main" (click)="toggleMap()">
      <mat-icon>close</mat-icon> Close Map
    </button>

    <div class="backdrop" *ngIf="selectedLocation" (click)="closePanel()"></div>

    <div class="side-panel" *ngIf="selectedLocation">
      <div class="panel-image-wrapper">
        <div class="image-carousel" *ngIf="selectedLocationImages.length > 0; else noMapImage">
          <img [src]="selectedLocationImages[selectedImageIndex]" alt="Location Preview">
          <button class="nav-btn prev" *ngIf="selectedLocationImages.length > 1" (click)="prevMapImage()">‹</button>
          <button class="nav-btn next" *ngIf="selectedLocationImages.length > 1" (click)="nextMapImage()">›</button>
        </div>
        <ng-template #noMapImage>
          <div class="placeholder-image"><mat-icon>image</mat-icon></div>
        </ng-template>
        <button class="close-icon-btn" (click)="closePanel()">✕</button>
      </div>

      <div class="panel-content">
        <h2>{{ selectedLocation.name }}</h2>
        <div class="info-row"><mat-icon>location_on</mat-icon> {{ selectedLocation.address }}</div>
        <div class="price-section">
          <div class="price">€{{ selectedLocation.price }} <span class="period">/ day</span></div>
          <button mat-flat-button color="primary" [routerLink]="['/reservation', selectedLocation.arcgis_feature_id]">
            Details
          </button>
        </div>
      </div>
    </div>
  </div>
</div>